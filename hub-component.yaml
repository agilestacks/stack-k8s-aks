---
version: 1
kind: component
meta:
  name: stack-k8s-aks
  brief: Azure AKS
  source:
      dir: ../../stack-k8s-aks/

provides:
  - kubernetes

lifecycle:
  verbs:
    - deploy
    - undeploy
  readyConditions:
    - dns: ${kubernetes.api.endpoint}
      url: https://${kubernetes.api.endpoint}

parameters:
  - name: kubernetes.flavor
    value: k8s-aks
  - name: cloud.kind
    value: azure  
  - name: terraform.account.name
    env: STATE_ACCOUNT
  - name: terraform.account.container
    env: STATE_CONTAINER
  - name: dns.domain
    env: DOMAIN_NAME
  - name: cloud.region
    env: TF_VAR_location
  - name: cloud.resource_group
    env: TF_VAR_resource_group_name

  - name: component.kubernetes
    parameters:
    - name: aks
      parameters:
      - name: agent_count
        env: TF_VAR_agent_count
      - name: agent_vm_size
        env: TF_VAR_agent_vm_size
        value: Standard_DS1_v2
      - name: agent_vm_os
        env: TF_VAR_agent_vm_os
        value: Linux

outputs:
  - name: cloud.kind
  - name: cloud.region
  - name: dns.domain
  - name: dns.name
    fromTfVar: dns_name
  - name: dns.baseDomain
    fromTfVar: dns_base_domain
  - name: kubernetes.flavor
  - name: kubernetes.api.host
    fromTfVar: fqdn
  - name: kubernetes.api.port
    value: 443
  - name: kubernetes.api.endpoint
    value: ${kubernetes.api.host}:${kubernetes.api.port} 
  - name: kubernetes.api.caCert
    fromTfVar: cluster_ca_certificate
  - name: kubernetes.api.clientCert
    fromTfVar: client_certificate
  - name: kubernetes.api.clientKey
    fromTfVar: client_key




